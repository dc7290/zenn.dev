---
title: "next/imageを使ってビルドに画像を最適化する方法"
emoji: "🎉"
type: "tech"
topics: ["nextjs"]
published: false
---

# はじめに

2022 年 5 月現在、`next/image`を`next export`で使う場合、
画像プロバイダーを使って外部 URL を利用する方法しかありません。
(`next/image`のデフォルトは、Nodejs サーバーを使用した画像最適化 API のもと行われるため)

しかし、シンプルなウェブサイトを構築する場合や Node.js サーバーを使用せずに構築したい場合にこれは不便です。

よってこの問題を解決するためのライブラリを開発しました。

- GitHub

https://github.com/dc7290/next-export-optimize-images

- ドキュメントサイト

https://next-export-optimize-images.vercel.app

# 特徴

主な特徴としまして、以下があります。

- ビルド時に画像を最適化
- `next/image`の全オプションが利用可能
- 拡張子の変換が可能
- `sharp`を使用し高速に動作
- キャッシュにより同じ最適化の繰り返しを防止

# 使い方

1. パッケージをインストールします。

```bash
yarn add -D next-export-optimize-images
```

2. `next.config.js`にプラグインを追加します。

```js:next.config.js
const withExportImages = require('next-export-optimize-images')

module.exports = withExportImages({
  // write your next.js configuration values.
})
```

3. `package.json`のビルドコマンドを変更します。

```diff json:package.json
{
-  "export": "next build && next export",
+  "export": "next build && next export && next-export-optimize-images",
}
```

4. 通常通り`next/image`を使用します。

```jsx
import Image from 'next/image'

<Image src="/images/img.png" width={1920} height={1280} alt="" />
// Or import as follows
<Image src={require('./img.png')} alt="" />
```

# 設定

デフォルトの動作は必要に応じて変更可能です。
ルートに`export-images.config.js`を作成します。

```js:export-images.config.js
/**
 * @type {import('next-export-optimize-images').Config}
 */
const config = {
  // your configuration values.
}

module.exports = config
```

詳細は[こちら](https://next-export-optimize-images.vercel.app/docs/configuration)のドキュメントサイトをご覧ください。

# 使用例

ここではいくつか使用例を紹介していきます。
ただ、`next/image`の使い方と基本的に同じですので、詳しくは[こちら](https://nextjs.org/docs/api-reference/next/image)の公式ドキュメントをご覧ください。

## `placeholder`を使用する

```jsx
<Image placeholder="blur" src="/images/img.png" width={1920} height={1280} alt="" />
// Or import as follows
<Image placeholder="blur" src={require('./img.png')} alt="" />
```

## `layout`を`fill`に設定する

```jsx
<Image layout="fill" objectFit="cover" src="/images/img.png" width={1920} height={1280} alt="" />
// Or import as follows
<Image layout="fill" objectFit="cover" src={require('./img.png')} alt="" />
```

## 独自の`loader`を設定する

```tsx:CMSImage.tsx
import { ImageLoaderProps, ImageProps } from 'next/image'
import { FC } from 'react'

type Props = ImageProps

const CMSLoader = ({ src, width, quality }: ImageLoaderProps) => {
  const url = new URL(normalizeSrc(src))
  const params = url.searchParams

  params.set('auto', params.get('auto') || 'format')
  params.set('fit', params.get('fit') || 'max')
  params.set('w', params.get('w') || width.toString())

  if (quality) {
    params.set('q', quality.toString())
  }

  return url.href
}

const CMSImage: FC<Props> = (props) => {
  return <Image loader={CMSLoader} {...props} />
}

export default CMSImage
```

# 内部構造

ここからは内部でどういった処理をしているのかが気になる人向けに内部構造を紹介します。
ライブラリを使用するために必要な知識ではないのでご安心ください。
